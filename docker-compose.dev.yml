services:
  # Neon Local proxy for development
  neon-local:
    image: neondatabase/neon_local:latest
    container_name: acquisitions-neon-local
    ports:
      - '5432:5432'
    env_file:
      - .env.development
    volumes:
      # Persist Neon Local metadata (optional)
      - ./.neon_local/:/tmp/.neon_local
      # Git branch detection for branch-per-feature development
      - ./.git/HEAD:/tmp/.git/HEAD:ro
    networks:
      - acquisitions-network
    healthcheck:
      test: ['CMD', 'pg_isready', '-h', 'localhost', '-p', '5432', '-U', 'neon']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Acquisitions API application
  app:
    build:
      context: .
      dockerfile: Dockerfile
      target: dev
    container_name: acquisitions-app-dev
    ports:
      - '3000:3000'
    env_file:
      -  .env.development
    volumes:
      # Mount source code for hot reload
      - ./src:/app/src:cached
      - ./package.json:/app/package.json:ro
      - ./drizzle.config.js:/app/drizzle.config.js:ro
      # Mount logs directory
      - ./logs:/app/logs
    depends_on:
      neon-local:
        condition: service_healthy
    networks:
      - acquisitions-network
    healthcheck:
      test:
        [
          'CMD',
          'node',
          '-e',
          "require('http').get('http://localhost:3000/health', (res) => { process.exit(res.statusCode === 200 ? 0 : 1) })",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  # Optional: Drizzle Studio for database management
  drizzle-studio:
    build:
      context: .
      dockerfile: Dockerfile
      target: dev
    container_name: acquisitions-drizzle-studio
    ports:
      - '4983:4983'
    env_file:
      - .env.development
    command: ['npm', 'run', 'db:studio']
    depends_on:
      neon-local:
        condition: service_healthy
    networks:
      - acquisitions-network
    profiles:
      - studio

networks:
  acquisitions-network:
    driver: bridge

volumes:
  neon_local_data:
